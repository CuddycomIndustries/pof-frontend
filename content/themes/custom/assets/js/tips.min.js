window.Tips = ( function( window, document, $ ){

    var app = {};

    app.cache = function() {        
        app.$section        = $("#tips__section");
        app.$tipsForm       = $("#tips__form_data");
    	app.$loader         = $("#tips__form_loader");
        app.$container      = $("#tips__form-container");
    	app.$counter        = $("#tip-count");    	          
        app.$saveButton     = $("#tips__save");
        app.$filesContainer = $("#tips__image_input_container");
        app.$addImage       = $("#add_image_input");
        app.$sorters        = app.$section.find(".sort-filter");
        app.$tips           = app.$section.find(".tip");

        app.pageID          = app.$section.data("page");
        app.fileIdx         = 0;
        app.loaded          = false;

        app.refresh();
    };

    app.refresh = function() {        
        app.$deleteButtons  = app.$tipsForm.find(".delete_image_input");
        app.$errors         = app.$section.find(".tips__error");
        app.$generalErr     = app.$section.find("#tips__general_errors");        

        app.$deleteButtons.on('click', function(e) {   
            app.stop(e);                 
            app.deleteImageInput(e);
        });
    };

    app.init = function(){
        // crawl the DOM
        app.cache();

        // init listjs
        app.initListJS();

        // event listeners
        app.$addImage.on('click', function(e) {   
            app.stop(e);         
            app.addImageInput(e);
        });
        app.$sorters.on('click', function(e) {
            app.stop(e);
            app.sortTips(e);
        });
        app.$tipsForm.submit(app.saveTip);

    };    

    app.initListJS = function() {
        var options = {
            valueNames: [ 'tip__date', 'likes-count' ],
            sortClass: 'sort-filter',
            page: 4,            
            plugins: [
                ListPagination({})
            ]
        };

        app.tipsList = new List('tips__list_container', options);  

        // list updated
        app.tipsList.on('updated', app.update);
    };

    app.update = function() {
        $('#tips__section').get(0).scrollIntoView();
    };

    app.addImageInput = function(e) {        
        var html    =  '<div class="clearfix file_input_container" id="image_input_container_' + ++app.fileIdx + '">';
        html        += '<input type="file" name="image_' + app.fileIdx + '" data-file="' + app.fileIdx + '"/>';
        html        += '<a class="button clearfix radius delete_image_input" data-delete-idx="' + app.fileIdx + '">-</a>';
        html        += '<small class="error tips__error" id="tips__error_image_' + app.fileIdx + '"></small>';
        html        += '</div>';

        app.$filesContainer.append(html);
        app.refresh();
    };

    app.deleteImageInput = function( e ) {
        var idx = e.target.dataset.deleteIdx;

        app.$filesContainer.find('#image_input_container_' + idx).remove();
    };

    app.saveTip = function() {        
        var formData = new FormData(this);     

        app.$errors.hide();
        app.$generalErr.html('');
        app.$loader.show();

        $.ajax({
            url: pof.ajaxurl,
            type: 'POST',
            data: formData,
            success: function (data) {
                data = JSON.parse(data);
                if ( data.status === 'error' ) {
                    app.handleError( data.message, data.data );
                } else {
                    app.handleSuccess( data.message, data.data );
                }
                app.$loader.hide();
            },
            cache: false,
            contentType: false,
            processData: false
        });

        return false;
    };

    app.loadTips = function() {
    	$(app.$loader).css("display", "block");

    	$.post(
			pof.ajaxurl,
			{
				action: 	"tips_controller",
				ctrl: 		"load",
				post_id: 	app.pageID,
				offset: 	2
			},
			function(data) {
				var response = jQuery.parseJSON(data);				

				$(app.$loader).css("display", "none");
				$(app.$section).append(response.data.html);
			}		
		).fail( function() {
			$(app.$loader).css("display", "none");
			$(app.$counter).html('(0)');
		});
    };

    app.sortTips = function(e) {
        var sorter = e.target.dataset.sorter;
        app.tipsList.sort(sorter, { order: "desc" });
        if ( e.target.className.indexOf("active") === -1 ) {
            app.$sorters.toggleClass("active");
        }
    };

    app.handleError = function( msg, errors) {

        if ( errors.general !== undefined ) {
            $.each(errors.general, function(idx, value) {            
                app.$generalErr.append('<p>' + value + '</p>').show();
            });   
        } else {
            $.each(errors, function(idx, value) {            
                app.$tipsForm.find('#tips__error_' + idx).html(value).show();
            });        
        }
    };

    app.handleSuccess = function( msg, data ) {        
        app.$container.html('<div data-alert class="alert-box info radius">' + msg + '</div>');
    };

    app.stop = function(e) {
        e.stopPropagation();
        e.preventDefault();
    };

    app.forEach = function(arr, cb) {
        for (var i = arr.length - 1; i >= 0; i--) {
            cb(arr[i]);
        }
    };

    $(document).ready( app.init );

    return app;

})( window, document, jQuery );

